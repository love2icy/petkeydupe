<script>
  const btn = document.getElementById('generate-btn');
  const resultEl = document.getElementById('result');
  const copyBtn = document.getElementById('copy-btn');
  const STORAGE_KEY = 'petDuperKeyData';
  const TIMER_DURATION_SEC = 5 * 60 * 60; // 5 hours

  btn.addEventListener('click', () => generateKey());
  copyBtn.addEventListener('click', copyKeyToClipboard);

  function getDeviceId() {
    let id = localStorage.getItem('deviceId');
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem('deviceId', id);
    }
    return id;
  }

  function loadSavedData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return null;
    try {
      return JSON.parse(saved);
    } catch {
      return null;
    }
  }

  function saveKeyData(key, expiryTimestamp) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      key,
      expiryTimestamp
    }));
  }

  function disableButton() {
    btn.disabled = true;
    btn.textContent = "Key Generated";
  }

  function enableButton() {
    btn.disabled = false;
    btn.textContent = "Generate Key";
  }

  function formatTime(seconds) {
    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function startCountdown(expiryTimestamp, key) {
    function update() {
      const now = Date.now();
      let diffSeconds = Math.floor((expiryTimestamp - now) / 1000);

      if (diffSeconds <= 0) {
        resultEl.textContent = "Key expired. You can now generate a new one.";
        enableButton();
        return;
      }

      resultEl.textContent = `Your Key:\n${key}\n\nExpires in: ${formatTime(diffSeconds)}`;
      requestAnimationFrame(update);
    }

    update();
  }

  window.onload = () => {
    const data = loadSavedData();

    btn.classList.remove('hidden');
    resultEl.classList.remove('hidden');

    if (data && data.key && data.expiryTimestamp) {
      const now = Date.now();
      if (now < data.expiryTimestamp) {
        disableButton();
        startCountdown(data.expiryTimestamp, data.key);
        showCopyBtn();
      } else {
        enableButton();
        resultEl.textContent = "Key expired. You can now generate a new one.";
      }
    }
  };

  async function generateKey() {
    if (btn.disabled) return;

    btn.textContent = 'Generating...';

    try {
      const deviceId = getDeviceId();
      const res = await fetch(`https://petkeydupe.onrender.com/generate-key?deviceId=${deviceId}`);
      const data = await res.json();

      if (data.success && data.key) {
        disableButton();
        const expiryTimestamp = Date.now() + TIMER_DURATION_SEC * 1000;
        saveKeyData(data.key, expiryTimestamp);
        startCountdown(expiryTimestamp, data.key);
        showCopyBtn();
      } else {
        resultEl.textContent = `Error: ${data.message || 'Failed to generate key'}`;
        btn.textContent = 'Generate Key';
      }
    } catch {
      resultEl.textContent = 'Network error or backend unreachable';
      btn.textContent = 'Generate Key';
    }
  }

  function copyKeyToClipboard() {
    const match = resultEl.textContent.match(/[A-Z0-9]{30}/);
    if (match) {
      navigator.clipboard.writeText(match[0]).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => {
          copyBtn.textContent = 'Copy Key';
        }, 1500);
      });
    }
  }

  function showCopyBtn() {
    copyBtn.style.display = 'block';
  }
</script>
